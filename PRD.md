# rcd - 命令列專案導航工具


## 1. 產品目標

提供一個高效、直覺的命令列工具，幫助使用者在分散於多個目錄下的眾多專案之間快速跳轉。本工具旨在透過智慧搜尋、互動式選單和快取機制，最大限度地減少手動 `cd` 和記憶路徑的負擔。

## 2. 核心概念

*  專案 (Project)：一個被版本控制系統管理的目錄。在本工具的定義中，任何包含 `.git` 子目錄的資料夾都被視為一個專案。
*  專案根目錄 (Project Root Directory)：使用者設定的、存放多個專案的頂層目錄。工具會掃描這些根目錄來尋找所有專案。也稱為「掃描路徑」。
*  快取 (Cache)：為了提升效能，工具會將掃描到的專案列表（名稱與路徑）儲存起來。這個列表在一段時間後會自動更新，也可以手動更新。

## 3. 命令列介面 (CLI) 設計

工具的基本指令為 `rcd`。

| 指令 / 選項 | 功能描述 |
| :--- | :--- |
| `rcd` | **互動模式**：無任何參數時，開啟一個可搜尋的互動式選單，列出所有專案。 |
| `rcd <關鍵字>` | **直接搜尋模式**：根據 `<關鍵字>` 立即搜尋專案並跳轉。 |
| `rcd -h` 或 `--help` | **幫助**：顯示使用說明、設定資訊和目前設定的掃描路徑。 |
| `rcd -l` 或 `--list` | **列表模式**：在終端機直接印出所有快取中的專案列表。 |
| `rcd -c` 或 `--clear` | **清除快取**：刪除目前的專案快取。下次執行任何搜尋或列表操作時會強制重建。 |
| `rcd --add <路徑>` | **新增掃描路徑**：將一個新的「專案根目錄」新增到設定中。 |
| `rcd --remove` | **移除掃描路徑**：開啟一個互動選單，讓使用者選擇並移除一個已設定的「專案根目錄」。 |

## 4. 詳細功能需求

### 4.1 專案探索與快取機制

1. 專案探索：
- 路徑有效性驗證 (Path Validity Check)：在掃描任何「專案根目錄」之前，工具必須先驗證該路徑是否仍然存在且為一個目錄。如果路徑無效，應跳過該路徑的掃描，並向使用者顯示一則警告訊息，指明是哪個路徑被跳過。
- 工具必須在所有已設定的「專案根目錄」下遞迴尋找專案。
- 搜尋深度應限制在 4 層以內（根目錄本身為第 1 層）。
- 一個目錄被識別為「專案」的唯一標準是其內部包含一個名為 `.git` 的子目錄。
2. 快取儲存：
- 探索到的每個專案，都必須記錄其「專案名稱」（即專案資料夾的名稱）和「完整絕對路徑」。
- 此列表應以 JSON 格式儲存於快取檔案中。
3. 快取生命週期：
- 快取的有效期限為 **4 小時 (14400 秒)**。
- 在執行任何需要專案列表的操作（如互動模式、直接搜尋、列表模式）時，工具必須先檢查快取。
- 快取重建觸發條件（滿足任一項即可）：
  - 快取檔案不存在。
  - 快取檔案的最後修改時間距今已超過 4 小時。
  - 使用者執行 `rcd -c` 指令。
  - 使用者成功執行 `rcd --add` 或 `rcd --remove` 指令。
4. 使用者反饋：
- 當觸發快取重建時，必須在終端機顯示訊息：「`重新建立專案路徑快取列表`」。
- 如果在所有掃描路徑中都找不到任何專案，必須顯示警告：「`警告：在指定的 repo root 中找不到任何 Git 專案`」。

### 4.2 互動模式 (`rcd`)

1. 介面：
- 執行 `rcd` 時，應立即進入一個全螢幕的互動式選單。
- 選單左側為主列表，右側為預覽區。預覽區約佔螢幕寬度的 50%。
2. 主列表顯示：
- 列表中的每一行代表一個專案。
- 每行需以固定寬度對齊，格式如下：
  - 第一欄：專案名稱，左對齊，佔用 35 個字元寬度。
  - 第二欄：專案的簡化路徑。
- 簡化路徑規則：顯示專案完整路徑的最後三部分。例如，路徑 `/Users/jackal/Desktop/my-project` 應顯示為 `jackal/Desktop/my-project`。如果路徑不足三部分，則顯示完整路徑。
3. 互動行為：
- 使用者可以透過輸入文字來對列表進行即時的**模糊搜尋**（子序列匹配）。
- 使用者可以透過上下方向鍵在篩選後的結果中導航。
4. 預覽區：
- 當使用者在主列表中反白某個專案時，右側的預覽區必須立即更新。
- 預覽區應顯示該專案目錄的**第一層級樹狀結構**，最多顯示 100 行，以避免內容過長。
5. 操作結果：
- 在選單中按下 `Enter` 鍵，工具必須立即將使用者的目前工作目錄切換到所選專案的目錄。
- 在選單中按下 `Escape` 鍵，工具應終止操作，並保持使用者目前的工作目錄不變。

### 4.3 直接搜尋模式 (`rcd <關鍵字>`)

1. 主要搜尋：
- 工具應首先對所有專案列表（同互動模式的顯示格式）進行一次**模糊搜尋**（子序列匹配）。
2. 容錯搜尋 (Fallback)：
- 如果主要搜尋沒有任何結果，工具**必須**自動執行第二次搜尋。
- 第二次搜尋是**容錯的**，應允許最多 **3 個字元**的錯誤（包括插入、刪除、替換）。
- 觸發容錯搜尋時，必須向使用者顯示提示：「`找不到精確匹配的項目，嘗試使用 ugrep 進行容錯搜尋...`」。
3. 操作結果：
- 如果任一搜尋（主要或容錯）找到至少一個匹配項，工具應自動將使用者的工作目錄切換到**結果列表中的第一個項目**所對應的專案目錄。
- 如果所有搜尋都失敗，則不執行任何操作，並保持使用者目前的工作目錄不變。

### 4.4 列表模式 (`rcd -l`)

1. 輸出格式：
- 此指令應直接在終端機印出所有快取中的專案。
- 其輸出格式與 **4.2.2** 中描述的互動模式主列表**完全相同**（專案名稱左對齊 35 字元寬，後接簡化路徑）。
- 輸出後，指令即結束，不進入任何互動環節。

### 4.5 設定管理

1. 新增掃描路徑 (`rcd --add <路徑>`)：
- 使用者必須提供一個 `<路徑>` 作為參數。若無，則顯示錯誤：「`錯誤：請提供要新增的路徑。`」和用法提示。
- 工具必須支援 `~` 作為家目錄的縮寫，並在處理時將其展開為絕對路徑。
- 工具必須驗證提供的路徑是否存在且為一個目錄。若否，則顯示錯誤：「`錯誤：路徑 '...' 不存在或不是一個目錄。`」。
- 工具必須檢查該路徑是否已存在於設定中。若已存在，則顯示提示：「`路徑 '...' 已存在，無需新增。`」。
- 驗證通過後，將該絕對路徑新增到設定檔中，並顯示成功訊息：「`成功新增路徑: ...`」。
- 成功新增後，**必須自動清除快取**。
2. 移除掃描路徑 (`rcd --remove`)：
- 執行此指令時，應開啟一個互動式選單，列出所有目前已設定的掃描路徑。
- 使用者可以透過模糊搜尋和上下鍵選擇一個要移除的路徑。
- 按下 `Enter` 鍵確認移除。移除後，顯示成功訊息：「`成功移除路徑: ...`」。
- 成功移除後，**必須自動清除快取**。
- 按下 `Escape` 鍵取消操作，並顯示提示：「`操作已取消。`」。

### 4.6 幫助畫面 (`rcd -h`)

執行此指令時，必須顯示以下結構的文字，其中設定檔、快取檔和根目錄列表必須是動態生成的當前狀態。

```txt
用法: rcd [選項] [關鍵字]

高效直覺的 cd cli 工具，快速切換專案目錄

選項:
 -h, --help    顯示此說明訊息
 -l, --list    列出所有快取中的專案名稱與其短路徑
 -c, --clear   清除快取，下次執行時將強制重建
 --add <path>  新增一個要掃描的專案根目錄
 --remove      以互動方式移除一個專案根目錄

行為:
 rcd           進入 fzf 互動式選單，支援 tree 預覽
 rcd <name>    直接搜尋專案，支援容錯搜尋 (三個字符)

---
設定檔: [使用者的設定檔絕對路徑]
快取檔: [使用者的快取檔絕對路徑]
目前掃描的根目錄:
 - [路徑 1]
 - [路徑 2]
```

## 5. 設定與資料檔案

1. 設定檔：
- 位置：`$HOME/.config/rcd/roots`
- 格式：純文字檔案，每行一個絕對路徑，代表一個「專案根目錄」。
- 首次執行：當設定檔首次被建立時，工具應進行智慧初始化，以提供無縫的啟動體驗：
  - 工具會自動偵測系統中是否存在一組預設的常用專案目錄（例如 $HOME/Desktop 或 /Volumes/development/projects）。
  - 只有實際存在於使用者系統中的目錄，才會被自動加入到初始的掃描路徑設定中。
  - 如果預設的目錄無一存在，設定檔在初始化後將會是空的，並由其他機制提示使用者手動新增（詳見 6. 錯誤處理與訊息）。
2. 快取檔：
- 位置：`$HOME/.cache/rcd-repos.json`
- 格式：一個 JSON 檔案，其內容為一個陣列。陣列中的每個元素都是一個物件，代表一個專案，格式為：`{"name": "專案名稱", "path": "專案的絕對路徑"}`。

## 6. 錯誤處理與訊息
- 當快取檔案存在但格式不正確（例如，不是有效的 JSON）時，應顯示錯誤：「`錯誤：快取檔案不存在或格式錯誤，請嘗試使用 'rcd -c' 清除快取`」。
- 當快取為空（可能是因為掃描路徑下沒有專案）時，應顯示提示：「`快取為空，請檢查 'roots' 設定或執行 'rcd -c' 清除後重試`」。
- 當首次執行且未找到任何有效的預設專案目錄時，應顯示指引訊息，例如：「警告：未在您的系統上找到任何預設專案目錄。請使用 'rcd --add <path>' 新增您的專案根目錄。」。
